version: '3.8'

# Docker Compose Override File for Security Hardening
# This file injects secrets and authenticated connection strings
# Docker Compose automatically merges this with docker-compose.prod.yml
#
# Usage:
#   docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d

services:
  mongodb:
    env_file:
      - ./.env.secrets
    environment:
      # Override with secrets from .env.secrets
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}

  redis:
    env_file:
      - ./.env.secrets
    environment:
      # Override with password from .env.secrets
      - REDIS_PASSWORD=${REDIS_PASSWORD}

  backend:
    env_file:
      - ./.env.secrets
    environment:
      # MongoDB connection with authentication
      # Variables are URL-encoded by run-prod.sh script to handle special characters
      # Use _ENCODED versions for connection strings, original for container env vars
      - MONGO_DETAILS=mongodb://${MONGO_INITDB_ROOT_USERNAME_ENCODED:-admin}:${MONGO_INITDB_ROOT_PASSWORD_ENCODED}@mongodb:27017/litecoin_rag_db?authSource=admin
      # Redis connection with password (if set, otherwise without password)
      # Note: If REDIS_PASSWORD is empty, this will create redis://:@redis:6379/0
      # The redis service handles empty passwords gracefully
      - REDIS_URL=${REDIS_PASSWORD_ENCODED:+redis://:${REDIS_PASSWORD_ENCODED}@redis:6379/0}${REDIS_PASSWORD_ENCODED:-redis://redis:6379/0}

  payload_cms:
    env_file:
      - ./.env.secrets
    environment:
      # MongoDB connection with authentication
      # Variables are URL-encoded by run-prod.sh script to handle special characters
      # Use _ENCODED versions for connection strings to properly escape special chars
      - DATABASE_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME_ENCODED:-admin}:${MONGO_INITDB_ROOT_PASSWORD_ENCODED}@mongodb:27017/payload_cms?authSource=admin

