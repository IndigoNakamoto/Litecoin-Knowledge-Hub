version: '3.8'

# Docker Compose Override File for Security Hardening
# This file injects secrets and authenticated connection strings.
# Docker Compose automatically merges this with docker-compose.prod.yml.
#
# Default: use **local MongoDB** (mongodb service) with credentials from .env.secrets.
# Optional: you can still point services at Atlas by overriding MONGO_URI / MONGO_DETAILS /
#           DATABASE_URI in .env.docker.prod or your shell.
#
# Usage:
#   docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d

services:
  # Inject secrets into local MongoDB container
  mongodb:
    env_file:
      - ./.env.secrets
    environment:
      # Override with secrets from .env.secrets (unencoded values for the container)
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}

  redis:
    env_file:
      - ./.env.secrets
    environment:
      # Override with password from .env.secrets
      - REDIS_PASSWORD=${REDIS_PASSWORD}

  # Redis Stack for local RAG vector cache (only starts with --profile local-rag)
  redis_stack:
    env_file:
      - ./.env.secrets
    environment:
      # Use same password as regular Redis for consistency
      - REDIS_PASSWORD=${REDIS_PASSWORD}

  backend:
    env_file:
      - ./.env.secrets
    environment:
      # MongoDB connection: by default point at the local mongodb service.
      # These values override any Atlas URIs that might be present in .env.docker.prod.
      - MONGO_DETAILS=mongodb://${MONGO_INITDB_ROOT_USERNAME_ENCODED:-admin}:${MONGO_INITDB_ROOT_PASSWORD_ENCODED}@mongodb:27017/litecoin_rag_db?authSource=admin
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME_ENCODED:-admin}:${MONGO_INITDB_ROOT_PASSWORD_ENCODED}@mongodb:27017/litecoin_rag_db?authSource=admin
      # Redis connection with password (if set, otherwise without password)
      - REDIS_URL=redis://${REDIS_PASSWORD_ENCODED:+:${REDIS_PASSWORD_ENCODED}@}redis:6379/0
      # Redis Stack URL for local RAG vector cache (uses same password as regular Redis)
      # Internal port is 6379, external host port is 6380
      - REDIS_STACK_URL=redis://${REDIS_PASSWORD_ENCODED:+:${REDIS_PASSWORD_ENCODED}@}redis_stack:6379

  payload_cms:
    env_file:
      - ./.env.secrets
    environment:
      # MongoDB connection for Payload CMS: default to local mongodb service.
      # This overrides any Atlas DATABASE_URI in .env.docker.prod.
      - DATABASE_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME_ENCODED:-admin}:${MONGO_INITDB_ROOT_PASSWORD_ENCODED}@mongodb:27017/payload_cms?authSource=admin

